# This is a basic workflow to help you get started with Actions

name: update-twlk

# Controls when the workflow will run
on:
  schedule:
    - cron: '30 23 * * *'
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  twlk:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      - name: Generate URLs and fetch content
        run: |
          # 定义URL处理函数
          process_source() {
            CONTENT=$(curl -s -f "$1" 2>/dev/null || echo "DOWNLOAD_FAILED")       
            if [ "$CONTENT" != "DOWNLOAD_FAILED" ] && [ -n "$CONTENT" ]; then
              echo "✓ 下载成功:$1 ($(echo "$CONTENT" | wc -c) 字节)"
              # 检查是否是 Base64 编码
              if echo "$CONTENT" | grep -q "^[A-Za-z0-9+/]*=*$" 2>/dev/null; then
                 echo "✓ 检测到 Base64 编码，进行解码..."       
                 # 尝试 Base64 解码
                 DECODED_CONTENT=$(echo "$CONTENT" | base64 -d 2>/dev/null || echo "$CONTENT")       
                 if [ "$DECODED_CONTENT" != "$CONTENT" ]; then
                    echo "✓ Base64 解码成功 ($(echo "$DECODED_CONTENT" | wc -c) 字节)"
                    FINAL_CONTENT="$DECODED_CONTENT"
                    STATUS="(Base64解码后)"
                 else
                    echo "✗ Base64 解码失败，使用原始内容"
                    FINAL_CONTENT="$CONTENT"
                    STATUS="(原始内容)"
                 fi        
              else
                 echo "✓ 不是 Base64 编码，使用原始内容"
                 FINAL_CONTENT="$CONTENT"
                 STATUS="(原始内容)"
              fi
               echo "$FINAL_CONTENT" >> twlk.txt
               echo "" >> twlk.txt
            else
              echo "✗ 下载失败: $1"
            fi
          }
          # 获取当前日期
          CURRENT_DATE=$(date -u '+%Y%m%d')
          CURRENT_YEAR=$(date -u '+%Y')
          CURRENT_MONTH=$(date -u '+%m')
          echo "" > twlk.txt
          #调用函数，依次获取
          process_source "https://node.freeclashnode.com/uploads/${CURRENT_YEAR}/${CURRENT_MONTH}/0-${CURRENT_DATE}.txt"
          process_source "https://v2rayshare.githubrowcontent.com/${CURRENT_YEAR}/${CURRENT_MONTH}/${CURRENT_DATE}.txt"
          process_source "https://v2clash.blog/Link/${CURRENT_DATE}-v2ray.txt"
          process_source "https://clashgithub.com/wp-content/uploads/rss/${CURRENT_DATE}.txt"
          process_source "https://oss.oneclash.cc/${CURRENT_YEAR}/${CURRENT_MONTH}/${CURRENT_DATE}.txt"
          
      - name: Commit and push if changed
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          if [ $(wc -l < twlk.txt) -gt 3 ]; then
            if git diff --quiet twlk.txt 2>/dev/null; then
              echo "No changes to commit"
            else
              git add twlk.txt
              git commit -m "Update twlk.txt - $(date '+%Y-%m-%d %H:%M UTC')"
              git push origin HEAD:main
            fi
          else
            echo "文件内容为空或过少，跳过提交以避免覆盖有效数据。"
          fi
