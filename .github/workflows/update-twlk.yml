name: Update TWLK File Daily

on:
  schedule:
    # 每天 UTC 时间 15:00 运行 (北京时间 23:00)
    - cron: '0 15 * * *'
  workflow_dispatch: # 允许手动触发
  push:
    branches:
      - main

jobs:
  update-twlk:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: Generate URLs and fetch content
      run: |
        # 获取当前日期
        CURRENT_DATE=$(date -u '+%Y%m%d')
        CURRENT_YEAR=$(date -u '+%Y')
        CURRENT_MONTH=$(date -u '+%m')
        
        URL1="https://node.freeclashnode.com/uploads/${CURRENT_YEAR}/${CURRENT_MONTH}/0-${CURRENT_DATE}.txt"
        URL2="https://v2rayshare.githubrowcontent.com/${CURRENT_YEAR}/${CURRENT_MONTH}/${CURRENT_DATE}.txt"
        URL3="https://v2clash.blog/Link/${CURRENT_DATE}-v2ray.txt"
        
        # 创建临时目录
        mkdir -p tmp
        
        # 下载第一个文件（如果存在）
        if curl -s --fail "$URL1" > "tmp/file1.txt" 2>/dev/null; then
            echo "✓ Successfully downloaded from URL1"
        else
            echo "✗ URL1 not found, trying previous day..."
            # 尝试前一天
            PREV_DATE=$(date -u -d 'yesterday' '+%Y%m%d')
            URL1="https://node.freeclashnode.com/uploads/${CURRENT_YEAR}/${CURRENT_MONTH}/0-${PREV_DATE}.txt"
            if curl -s --fail "$URL1" > "tmp/file1.txt" 2>/dev/null; then
                echo "✓ Successfully downloaded previous day from URL1"
            else
                echo "✗ Previous day also not found for URL1"
            fi
        fi
        
        # 下载第二个文件（如果存在）
        if curl -s --fail "$URL2" > "tmp/file2.txt" 2>/dev/null; then
            echo "✓ Successfully downloaded from URL2"
        else
            echo "✗ URL2 not found, trying previous day..."
            # 尝试前一天
            PREV_DATE=$(date -u -d 'yesterday' '+%Y%m%d')
            URL2="https://v2rayshare.githubrowcontent.com/${CURRENT_YEAR}/${CURRENT_MONTH}/${PREV_DATE}.txt"
            if curl -s --fail "$URL2" > "tmp/file2.txt" 2>/dev/null; then
                echo "✓ Successfully downloaded previous day from URL2"
            else
                echo "✗ Previous day also not found for URL2"
            fi
        fi

        # 下载第3个文件（如果存在）
        if curl -s --fail "$URL3" > "tmp/file3.txt" 2>/dev/null; then
            echo "✓ Successfully downloaded from URL3"
        else
            echo "✗ URL3 not found, trying previous day..."
            # 尝试前一天
            PREV_DATE=$(date -u -d 'yesterday' '+%Y%m%d')
            URL3="https://v2clash.blog/Link/${PREV_DATE}-v2ray.txt"
            if curl -s --fail "$URL3" > "tmp/file3.txt" 2>/dev/null; then
                echo "✓ Successfully downloaded previous day from URL3"
            else
                echo "✗ Previous day also not found for URL3"
            fi
        fi
        
        # 合并文件到 twlk.txt
        cat tmp/file1.txt > twlk.txt
        # cat tmp/file2.txt >> twlk.txt
        # cat tmp/file3.txt >> twlk.txt
        
    - name: Commit and push if changed
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        if git diff --quiet twlk.txt; then
          echo "No changes to commit"
        else
          git add twlk.txt
          git commit -m "Update twlk.txt - $(date '+%Y-%m-%d')" || exit 0
          git push
        fi
