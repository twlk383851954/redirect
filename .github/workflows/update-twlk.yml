name: Update TWLK File Daily

on:
  schedule:
    # 每天 UTC 时间 15:00 运行 (北京时间 23:00)
    - cron: '0 15 * * *'

jobs:
  update-twlk:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
        
    - name: Generate URLs and fetch content
      run: |
        # 定义URL处理函数
        process_source() {
          CONTENT=$(curl -s -f "$1" 2>/dev/null || echo "DOWNLOAD_FAILED")       
          if [ "$CONTENT" != "DOWNLOAD_FAILED" ] && [ -n "$CONTENT" ]; then
            echo "✓ 下载成功:$1 ($(echo "$CONTENT" | wc -c) 字节)"
            # 检查是否是 Base64 编码
            if echo "$CONTENT" | grep -q "^[A-Za-z0-9+/]*=*$" 2>/dev/null; then
               echo "✓ 检测到 Base64 编码，进行解码..."       
               # 尝试 Base64 解码
               DECODED_CONTENT=$(echo "$CONTENT" | base64 -d 2>/dev/null || echo "$CONTENT")       
               if [ "$DECODED_CONTENT" != "$CONTENT" ]; then
                  echo "✓ Base64 解码成功 ($(echo "$DECODED_CONTENT" | wc -c) 字节)"
                  FINAL_CONTENT="$DECODED_CONTENT"
                  STATUS="(Base64解码后)"
               else
                  echo "✗ Base64 解码失败，使用原始内容"
                  FINAL_CONTENT="$CONTENT"
                  STATUS="(原始内容)"
               fi        
            else
               echo "✓ 不是 Base64 编码，使用原始内容"
               FINAL_CONTENT="$CONTENT"
               STATUS="(原始内容)"
            fi
             echo "$FINAL_CONTENT" >> twlk.txt
             echo "" >> twlk.txt
          else
            echo "✗ 下载失败: $1"
          fi
         }
        # 获取当前日期
        CURRENT_DATE=$(date -u '+%Y%m%d')
        CURRENT_YEAR=$(date -u '+%Y')
        CURRENT_MONTH=$(date -u '+%m')
        echo "" > twlk.txt
        #调用函数，依次获取
        process_source "https://node.freeclashnode.com/uploads/${CURRENT_YEAR}/${CURRENT_MONTH}/0-${CURRENT_DATE}.txt"
        process_source "https://v2rayshare.githubrowcontent.com/${CURRENT_YEAR}/${CURRENT_MONTH}/${CURRENT_DATE}.txt"
        process_source "https://v2clash.blog/Link/${CURRENT_DATE}-v2ray.txt"
        process_source "https://clashgithub.com/wp-content/uploads/rss/${CURRENT_DATE}.txt"
        process_source "https://oss.oneclash.cc/${CURRENT_YEAR}/${CURRENT_MONTH}/${CURRENT_DATE}.txt"
        
    - name: Commit and push if changed
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        if git diff --quiet twlk.txt; then
          echo "No changes to commit"
        else
          git add twlk.txt
          git commit -m "Update twlk.txt - $(date '+%Y-%m-%d')" || exit 0
          git push
        fi
